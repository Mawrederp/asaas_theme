

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

frappe.ui.Capture = function () {
	function _class() {
		var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

		_classCallCheck(this, _class);

		this.options = Object.assign({}, frappe.ui.Capture.DEFAULT_OPTIONS, options);
		this.dialog = new frappe.ui.Dialog();
		this.template = '\n\t\t\t<div class="text-center">\n\t\t\t\t<div class="img-thumbnail" style="border: none;">\n\t\t\t\t\t<div id="frappe-capture"/>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<div id="frappe-capture-btn-toolbar" style="padding-top: 15px; padding-bottom: 15px;">\n\t\t\t\t<div class="text-center">\n\t\t\t\t\t<div id="frappe-capture-btn-toolbar-snap">\n\t\t\t\t\t\t<a id="frappe-capture-btn-snap">\n\t\t\t\t\t\t\t<i class="fa fa-fw fa-2x fa-circle-o"/>\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="btn-group" id="frappe-capture-btn-toolbar-knap">\n\t\t\t\t\t\t<button class="btn btn-default" id="frappe-capture-btn-discard">\n\t\t\t\t\t\t\t<i class="fa fa-fw fa-arrow-left"/>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t\t<button class="btn btn-default" id="frappe-capture-btn-accept">\n\t\t\t\t\t\t\t<i class="fa fa-fw fa-arrow-right"/>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t';
		$(this.dialog.body).append(this.template);

		this.$btnBarSnap = $(this.dialog.body).find('#frappe-capture-btn-toolbar-snap');
		this.$btnBarKnap = $(this.dialog.body).find('#frappe-capture-btn-toolbar-knap');
		this.$btnBarKnap.hide();

		Webcam.set(this.options);
	}

	_createClass(_class, [{
		key: 'open',
		value: function open() {
			this.dialog.show();

			Webcam.attach('#frappe-capture');
		}
	}, {
		key: 'freeze',
		value: function freeze() {
			this.$btnBarSnap.hide();
			this.$btnBarKnap.show();

			Webcam.freeze();
		}
	}, {
		key: 'unfreeze',
		value: function unfreeze() {
			this.$btnBarSnap.show();
			this.$btnBarKnap.hide();

			Webcam.unfreeze();
		}
	}, {
		key: 'click',
		value: function click(callback) {
			var _this = this;

			$(this.dialog.body).find('#frappe-capture-btn-snap').click(function () {
				_this.freeze();

				$(_this.dialog.body).find('#frappe-capture-btn-discard').click(function () {
					_this.unfreeze();
				});

				$(_this.dialog.body).find('#frappe-capture-btn-accept').click(function () {
					Webcam.snap(function (data) {
						callback(data);
					});

					_this.hide();
				});
			});
		}
	}, {
		key: 'hide',
		value: function hide() {
			Webcam.reset();

			$(this.dialog.$wrapper).remove();
		}
	}]);

	return _class;
}();
frappe.ui.Capture.DEFAULT_OPTIONS = {
	width: 480, height: 320, flip_horiz: true
};

frappe.ui.form.make_control = function (opts) {
	var control_class_name = "Control" + opts.df.fieldtype.replace(/ /g, "");
	if (frappe.ui.form[control_class_name]) {
		return new frappe.ui.form[control_class_name](opts);
	} else {
		console.log("Invalid Control Name: " + opts.df.fieldtype);
	}
};

frappe.ui.form.Control = Class.extend({
	init: function init(opts) {
		$.extend(this, opts);
		this.make();

		if (frappe.boot.user && frappe.boot.user.name === "Administrator" && frappe.boot.developer_mode === 1 && this.$wrapper) {
			this.$wrapper.attr("title", __(this.df.fieldname));
		}

		if (this.render_input) {
			this.refresh();
		}
	},
	make: function make() {
		this.make_wrapper();
		this.$wrapper.attr("data-fieldtype", this.df.fieldtype).attr("data-fieldname", this.df.fieldname);
		this.wrapper = this.$wrapper.get(0);
		this.wrapper.fieldobj = this;
	},

	make_wrapper: function make_wrapper() {
		this.$wrapper = $("<div class='frappe-control'></div>").appendTo(this.parent);

		this.wrapper = this.$wrapper;
	},

	toggle: function toggle(show) {
		this.df.hidden = show ? 0 : 1;
		this.refresh();
	},

	get_status: function get_status(explain) {
		if (this.df.get_status) {
			return this.df.get_status(this);
		}

		if (!this.doctype && !this.docname) {
			if (cint(this.df.hidden)) {
				if (explain) console.log("By Hidden: None");
				return "None";
			} else if (cint(this.df.hidden_due_to_dependency)) {
				if (explain) console.log("By Hidden Dependency: None");
				return "None";
			} else if (cint(this.df.read_only)) {
				if (explain) console.log("By Read Only: Read");
				return "Read";
			}

			return "Write";
		}

		var status = frappe.perm.get_field_display_status(this.df, frappe.model.get_doc(this.doctype, this.docname), this.perm || this.frm && this.frm.perm, explain);

		if (this.doctype && status === "Read" && !this.only_input && is_null(frappe.model.get_value(this.doctype, this.docname, this.df.fieldname)) && !in_list(["HTML", "Image"], this.df.fieldtype)) {
			if (explain) console.log("By Hide Read-only, null fields: None");
			status = "None";
		}

		return status;
	},
	refresh: function refresh() {
		this.disp_status = this.get_status();
		this.$wrapper && this.$wrapper.toggleClass("hide-control", this.disp_status == "None") && this.refresh_input && this.refresh_input();
	},
	get_doc: function get_doc() {
		return this.doctype && this.docname && locals[this.doctype] && locals[this.doctype][this.docname] || {};
	},
	get_model_value: function get_model_value() {
		if (this.doc) {
			return this.doc[this.df.fieldname];
		}
	},
	set_value: function set_value(value) {
		return this.validate_and_set_in_model(value);
	},
	parse_validate_and_set_in_model: function parse_validate_and_set_in_model(value, e) {
		if (this.parse) {
			value = this.parse(value);
		}
		return this.validate_and_set_in_model(value, e);
	},
	validate_and_set_in_model: function validate_and_set_in_model(value, e) {
		var me = this;
		if (this.inside_change_event) {
			return Promise.resolve();
		}
		this.inside_change_event = true;
		var set = function set(value) {
			me.inside_change_event = false;
			return frappe.run_serially([function () {
				return me.set_model_value(value);
			}, function () {
				me.set_mandatory && me.set_mandatory(value);

				if (me.df.change || me.df.onchange) {
					return (me.df.change || me.df.onchange).apply(me, [e]);
				}
			}]);
		};

		value = this.validate(value);
		if (value && value.then) {
			return value.then(function (value) {
				return set(value);
			});
		} else {
			return set(value);
		}
	},
	get_value: function get_value() {
		if (this.get_status() === 'Write') {
			return this.get_input_value ? this.parse ? this.parse(this.get_input_value()) : this.get_input_value() : undefined;
		} else {
			return this.value || undefined;
		}
	},
	set_model_value: function set_model_value(value) {
		if (this.doctype && this.docname) {
			this.last_value = value;
			return frappe.model.set_value(this.doctype, this.docname, this.df.fieldname, value, this.df.fieldtype);
		} else {
			if (this.doc) {
				this.doc[this.df.fieldname] = value;
			}
			this.set_input(value);
			return Promise.resolve();
		}
	},
	set_focus: function set_focus() {
		if (this.$input) {
			this.$input.get(0).focus();
			return true;
		}
	}
});

frappe.ui.form.ControlInput = frappe.ui.form.Control.extend({
	horizontal: true,
	make: function make() {
		this._super();
		this.set_input_areas();

		this.set_max_width();
	},
	make_wrapper: function make_wrapper() {
		if (this.only_input) {
			this.$wrapper = $('<div class="form-group frappe-control">').appendTo(this.parent);
		} else {
			this.$wrapper = $('<div class="frappe-control">\
				<div class="form-group">\
					<div class="clearfix">\
						<label class="control-label" style="padding-right: 0px;"></label>\
					</div>\
					<div class="control-input-wrapper">\
						<div class="control-input"></div>\
						<div class="control-value like-disabled-input" style="display: none;"></div>\
						<p class="help-box small text-muted hidden-xs"></p>\
					</div>\
				</div>\
			</div>').appendTo(this.parent);
		}
	},
	toggle_label: function toggle_label(show) {
		this.$wrapper.find(".control-label").toggleClass("hide", !show);
	},
	toggle_description: function toggle_description(show) {
		this.$wrapper.find(".help-box").toggleClass("hide", !show);
	},
	set_input_areas: function set_input_areas() {
		if (this.only_input) {
			this.input_area = this.wrapper;
		} else {
			this.label_area = this.label_span = this.$wrapper.find("label").get(0);
			this.input_area = this.$wrapper.find(".control-input").get(0);
			this.$input_wrapper = this.$wrapper.find(".control-input-wrapper");

			this.disp_area = this.$wrapper.find(".control-value").get(0);
		}
	},
	set_max_width: function set_max_width() {
		if (this.horizontal) {
			this.$wrapper.addClass("input-max-width");
		}
	},

	refresh_input: function refresh_input() {
		var me = this;
		var make_input = function make_input() {
			if (!me.has_input) {
				me.make_input();
				if (me.df.on_make) {
					me.df.on_make(me);
				}
			}
		};

		var update_input = function update_input() {
			if (me.doctype && me.docname) {
				me.set_input(me.value);
			} else {
				me.set_input(me.value || null);
			}
		};

		if (me.disp_status != "None") {
			if (me.doctype && me.docname) {
				me.value = frappe.model.get_value(me.doctype, me.docname, me.df.fieldname);
			}

			if (me.disp_status == "Write") {
				me.disp_area && $(me.disp_area).toggle(false);
				$(me.input_area).toggle(true);
				me.$input && me.$input.prop("disabled", false);
				make_input();
				update_input();
			} else {
				if (me.only_input) {
					make_input();
					update_input();
				} else {
					$(me.input_area).toggle(false);
					if (me.disp_area) {
						me.set_disp_area(me.value);
						$(me.disp_area).toggle(true);
					}
				}
				me.$input && me.$input.prop("disabled", true);
			}

			me.set_description();
			me.set_label();
			me.set_mandatory(me.value);
			me.set_bold();
		}
	},

	set_disp_area: function set_disp_area(value) {
		if (in_list(["Currency", "Int", "Float"], this.df.fieldtype) && (this.value === 0 || value === 0)) {
			value = 0;
		} else {
			value = this.value || value;
		}
		this.disp_area && $(this.disp_area).html(frappe.format(value, this.df, { no_icon: true, inline: true }, this.doc || this.frm && this.frm.doc));
	},

	bind_change_event: function bind_change_event() {
		var me = this;
		this.$input && this.$input.on("change", this.change || function (e) {
			me.parse_validate_and_set_in_model(me.get_input_value(), e);
		});
	},
	bind_focusout: function bind_focusout() {
		if (frappe.dom.is_touchscreen()) {
			var me = this;
			this.$input && this.$input.on("focusout", function () {
				if (frappe.dom.is_touchscreen()) {
					frappe.utils.scroll_to(me.$wrapper);
				}
			});
		}
	},
	set_label: function set_label(label) {
		if (label) this.df.label = label;

		if (this.only_input || this.df.label == this._label) return;

		var icon = "";
		this.label_span.innerHTML = (icon ? '<i class="' + icon + '"></i> ' : "") + __(this.df.label) || "&nbsp;";
		this._label = this.df.label;
	},
	set_description: function set_description(description) {
		if (description !== undefined) {
			this.df.description = description;
		}
		if (this.only_input || this.df.description === this._description) {
			return;
		}
		if (this.df.description) {
			this.$wrapper.find(".help-box").html(__(this.df.description));
		} else {
			this.set_empty_description();
		}
		this._description = this.df.description;
	},
	set_new_description: function set_new_description(description) {
		this.$wrapper.find(".help-box").html(description);
	},
	set_empty_description: function set_empty_description() {
		this.$wrapper.find(".help-box").html("");
	},
	set_mandatory: function set_mandatory(value) {
		this.$wrapper.toggleClass("has-error", this.df.reqd && is_null(value) ? true : false);
	},
	set_bold: function set_bold() {
		if (this.$input) {
			this.$input.toggleClass("bold", !!(this.df.bold || this.df.reqd));
		}
		if (this.disp_area) {
			$(this.disp_area).toggleClass("bold", !!(this.df.bold || this.df.reqd));
		}
	}
});

frappe.ui.form.ControlData = frappe.ui.form.ControlInput.extend({
	html_element: "input",
	input_type: "text",
	make_input: function make_input() {
		if (this.$input) return;

		this.$input = $("<" + this.html_element + ">").attr("type", this.input_type).attr("autocomplete", "off").addClass("input-with-feedback form-control").prependTo(this.input_area);

		if (in_list(['Data', 'Link', 'Dynamic Link', 'Password', 'Select', 'Read Only', 'Attach', 'Attach Image'], this.df.fieldtype)) {
			this.$input.attr("maxlength", this.df.length || 140);
		}

		this.set_input_attributes();
		this.input = this.$input.get(0);
		this.has_input = true;
		this.bind_change_event();
		this.bind_focusout();
		this.setup_autoname_check();
	},
	setup_autoname_check: function setup_autoname_check() {
		var _this = this;

		if (!this.df.parent) return;
		this.meta = frappe.get_meta(this.df.parent);
		if (this.meta && (this.meta.autoname && this.meta.autoname.substr(0, 6) === 'field:' && this.meta.autoname.substr(6) === this.df.fieldname || this.df.fieldname === '__newname')) {
			this.$input.on('keyup', function () {
				_this.set_description('');
				if (_this.doc && _this.doc.__islocal) {
					var timeout = setTimeout(function () {
						if (_this.last_check) clearTimeout(_this.last_check);

						frappe.db.get_value(_this.doctype, _this.$input.val(), 'name', function (val) {
							if (val) {
								_this.set_description(__('{0} already exists. Select another name', [val.name]));
							}
						});
						_this.last_check = null;
					}, 1000);
					_this.last_check = timeout;
				}
			});
		}
	},
	set_input_attributes: function set_input_attributes() {
		this.$input.attr("data-fieldtype", this.df.fieldtype).attr("data-fieldname", this.df.fieldname).attr("placeholder", this.df.placeholder || "");
		if (this.doctype) {
			this.$input.attr("data-doctype", this.doctype);
		}
		if (this.df.input_css) {
			this.$input.css(this.df.input_css);
		}
		if (this.df.input_class) {
			this.$input.addClass(this.df.input_class);
		}
	},
	set_input: function set_input(value) {
		this.last_value = this.value;
		this.value = value;
		this.set_formatted_input(value);
		this.set_disp_area(value);
		this.set_mandatory && this.set_mandatory(value);
	},
	set_formatted_input: function set_formatted_input(value) {
		this.$input && this.$input.val(this.format_for_input(value));
	},
	get_input_value: function get_input_value() {
		return this.$input ? this.$input.val() : undefined;
	},
	format_for_input: function format_for_input(val) {
		return val == null ? "" : val;
	},
	validate: function validate(v) {
		if (this.df.options == 'Phone') {
			if (v + '' == '') {
				return '';
			}
			var v1 = '';

			v = v.replace(/ /g, '').replace(/-/g, '').replace(/\(/g, '').replace(/\)/g, '');

			if (v && v.substr(0, 1) == '+') {
				v1 = '+';v = v.substr(1);
			}
			if (v && v.substr(0, 2) == '00') {
				v1 += '00';v = v.substr(2);
			}
			if (v && v.substr(0, 1) == '0') {
				v1 += '0';v = v.substr(1);
			}
			v1 += cint(v) + '';
			return v1;
		} else if (this.df.options == 'Email') {
			if (v + '' == '') {
				return '';
			}

			var email_list = frappe.utils.split_emails(v);
			if (!email_list) {
				return '';
			} else {
				var invalid_email = false;
				email_list.forEach(function (email) {
					if (!validate_email(email)) {
						frappe.msgprint(__("Invalid Email: {0}", [email]));
						invalid_email = true;
					}
				});

				if (invalid_email) {
					return '';
				} else {
					return v;
				}
			}
		} else {
			return v;
		}
	}
});

frappe.ui.form.ControlInt = frappe.ui.form.ControlData.extend({
	make: function make() {
		this._super();
	},
	make_input: function make_input() {
		var me = this;
		this._super();
		this.$input.on("focus", function () {
			setTimeout(function () {
				if (!document.activeElement) return;
				document.activeElement.value = me.validate(document.activeElement.value);
				document.activeElement.select();
			}, 100);
			return false;
		});
	},
	parse: function parse(value) {
		return cint(value, null);
	}
});

frappe.ui.form.ControlFloat = frappe.ui.form.ControlInt.extend({
	parse: function parse(value) {
		return isNaN(parseFloat(value)) ? null : flt(value, this.get_precision());
	},

	format_for_input: function format_for_input(value) {
		var number_format;
		if (this.df.fieldtype === "Float" && this.df.options && this.df.options.trim()) {
			number_format = this.get_number_format();
		}
		var formatted_value = format_number(parseFloat(value), number_format, this.get_precision());
		return isNaN(parseFloat(value)) ? "" : formatted_value;
	},

	get_number_format: function (_get_number_format) {
		function get_number_format() {
			return _get_number_format.apply(this, arguments);
		}

		get_number_format.toString = function () {
			return _get_number_format.toString();
		};

		return get_number_format;
	}(function () {
		var currency = frappe.meta.get_field_currency(this.df, this.get_doc());
		return get_number_format(currency);
	}),

	get_precision: function get_precision() {
		return this.df.precision || cint(frappe.boot.sysdefaults.float_precision, null);
	}
});

frappe.ui.form.ControlPercent = frappe.ui.form.ControlFloat;

frappe.ui.form.ControlCurrency = frappe.ui.form.ControlFloat.extend({
	format_for_input: function format_for_input(value) {
		var formatted_value = format_number(parseFloat(value), this.get_number_format(), this.get_precision());
		return isNaN(parseFloat(value)) ? "" : formatted_value;
	},

	get_precision: function get_precision() {
		if (!this.df.precision) {
			if (frappe.boot.sysdefaults.currency_precision) {
				this.df.precision = frappe.boot.sysdefaults.currency_precision;
			} else {
				this.df.precision = get_number_format_info(this.get_number_format()).precision;
			}
		}

		return this.df.precision;
	}
});

frappe.ui.form.ControlDate = frappe.ui.form.ControlData.extend({
	make_input: function make_input() {
		this._super();
		this.set_date_options();
		this.set_datepicker();
		this.set_t_for_today();
	},
	set_formatted_input: function set_formatted_input(value) {
		this._super(value);
		if (!this.datepicker) return;
		if (!value) {
			this.datepicker.clear();
			return;
		}

		var should_refresh = this.last_value && this.last_value !== value;

		if (!should_refresh) {
			if (this.datepicker.selectedDates.length > 0) {
				var selected_date = moment(this.datepicker.selectedDates[0]).format(this.date_format);
				should_refresh = selected_date !== value;
			} else {
				should_refresh = true;
			}
		}

		if (should_refresh) {
			this.datepicker.selectDate(frappe.datetime.str_to_obj(value));
		}
	},
	set_date_options: function set_date_options() {
		var _this = this;

		var me = this;
		var lang = frappe.boot.user.language;
		if (!$.fn.datepicker.language[lang]) {
			lang = 'en';
		}
		this.today_text = __("Today");
		this.date_format = moment.defaultDateFormat;
		this.datepicker_options = {
			language: lang,
			autoClose: true,
			todayButton: true,
			dateFormat: frappe.boot.sysdefaults.date_format || 'yyyy-mm-dd',
			startDate: frappe.datetime.now_date(true),
			keyboardNav: false,
			onSelect: function onSelect() {
				_this.$input.trigger('change');
			},
			onShow: function onShow() {
				_this.datepicker.$datepicker.find('.datepicker--button:visible').text(me.today_text);

				_this.update_datepicker_position();
			}
		};
	},
	update_datepicker_position: function update_datepicker_position() {
		if (!this.frm) return;

		var window_height = $(window).height();
		var window_scroll_top = $(window).scrollTop();
		var el_offset_top = this.$input.offset().top + 280;
		var position = 'top left';
		if (window_height + window_scroll_top >= el_offset_top) {
			position = 'bottom left';
		}
		this.datepicker.update('position', position);
	},
	set_datepicker: function set_datepicker() {
		var _this2 = this;

		this.$input.datepicker(this.datepicker_options);
		this.datepicker = this.$input.data('datepicker');

		this.datepicker.$datepicker.find('[data-action="today"]').click(function () {
			_this2.datepicker.selectDate(_this2.get_now_date());
		});
	},
	get_now_date: function get_now_date() {
		return frappe.datetime.now_date(true);
	},
	set_t_for_today: function set_t_for_today() {
		var me = this;
		this.$input.on("keydown", function (e) {
			if (e.which === 84) {
				if (me.df.fieldtype == 'Date') {
					me.set_value(frappe.datetime.nowdate());
				}if (me.df.fieldtype == 'Datetime') {
					me.set_value(frappe.datetime.now_datetime());
				}if (me.df.fieldtype == 'Time') {
					me.set_value(frappe.datetime.now_time());
				}
				return false;
			}
		});
	},
	parse: function parse(value) {
		if (value) {
			return frappe.datetime.user_to_str(value);
		}
	},
	format_for_input: function format_for_input(value) {
		if (value) {
			return frappe.datetime.str_to_user(value);
		}
		return "";
	},
	validate: function validate(value) {
		if (value && !frappe.datetime.validate(value)) {
			frappe.msgprint(__("Date must be in format: {0}", [frappe.sys_defaults.date_format || "yyyy-mm-dd"]));
			return '';
		}
		return value;
	}
});

frappe.ui.form.ControlTime = frappe.ui.form.ControlData.extend({
	make_input: function make_input() {
		var _this = this;

		var me = this;
		this._super();
		this.$input.datepicker({
			language: "en",
			timepicker: true,
			onlyTimepicker: true,
			timeFormat: "hh:ii:ss",
			startDate: frappe.datetime.now_time(true),
			onSelect: function onSelect() {
				if (moment(me.get_value(), 'hh:mm:ss').format('HH:mm:ss') != moment(me.value, 'hh:mm:ss').format('HH:mm:ss')) {
					me.$input.trigger('change');
				}
			},
			onShow: function onShow() {
				$('.datepicker--button:visible').text(__('Now'));
			},
			keyboardNav: false,
			todayButton: true
		});
		this.datepicker = this.$input.data('datepicker');
		this.datepicker.$datepicker.find('[data-action="today"]').click(function () {
			_this.datepicker.selectDate(frappe.datetime.now_time(true));
		});
		this.refresh();
	},
	set_input: function set_input(value) {
		this._super(value);
		if (value && (this.last_value && this.last_value !== this.value || !this.datepicker.selectedDates.length)) {

			var date_obj = frappe.datetime.moment_to_date_obj(moment(value, 'HH:mm:ss'));
			this.datepicker.selectDate(date_obj);
		}
	},
	set_description: function set_description() {
		var description = this.df.description;
		var time_zone = frappe.sys_defaults.time_zone;

		if (!frappe.datetime.is_timezone_same()) {
			if (!description) {
				this.df.description = time_zone;
			} else if (!description.includes(time_zone)) {
				this.df.description += '<br>' + time_zone;
			}
		}
		this._super();
	}
});

frappe.ui.form.ControlDatetime = frappe.ui.form.ControlDate.extend({
	set_date_options: function set_date_options() {
		this._super();
		this.today_text = __("Now");
		this.date_format = moment.defaultDatetimeFormat;
		$.extend(this.datepicker_options, {
			timepicker: true,
			timeFormat: "hh:ii:ss"
		});
	},
	get_now_date: function get_now_date() {
		return frappe.datetime.now_datetime(true);
	},
	set_description: function set_description() {
		var description = this.df.description;
		var time_zone = frappe.sys_defaults.time_zone;

		if (!frappe.datetime.is_timezone_same()) {
			if (!description) {
				this.df.description = time_zone;
			} else if (!description.includes(time_zone)) {
				this.df.description += '<br>' + time_zone;
			}
		}
		this._super();
	}
});

frappe.ui.form.ControlDateRange = frappe.ui.form.ControlData.extend({
	make_input: function make_input() {
		this._super();
		this.set_date_options();
		this.set_datepicker();
		this.refresh();
	},
	set_date_options: function set_date_options() {
		var me = this;
		this.datepicker_options = {
			language: "en",
			range: true,
			autoClose: true,
			toggleSelected: false
		};
		this.datepicker_options.dateFormat = frappe.boot.sysdefaults.date_format || 'yyyy-mm-dd';
		this.datepicker_options.onSelect = function () {
			me.$input.trigger('change');
		};
	},
	set_datepicker: function set_datepicker() {
		this.$input.datepicker(this.datepicker_options);
		this.datepicker = this.$input.data('datepicker');
	},
	set_input: function set_input(value, value2) {
		this.last_value = this.value;
		if (value && value2) {
			this.value = [value, value2];
		} else {
			this.value = value;
		}
		if (this.value) {
			var formatted = this.format_for_input(this.value[0], this.value[1]);
			this.$input && this.$input.val(formatted);
		} else {
			this.$input && this.$input.val("");
		}
		this.set_disp_area(value || '');
		this.set_mandatory && this.set_mandatory(value);
	},
	parse: function parse(value) {
		var to = __('{0} to {1}').replace('{0}', '').replace('{1}', '');
		value = value.replace(to, ',');

		if (value && value.includes(',')) {
			var vals = value.split(',');
			var from_date = moment(frappe.datetime.user_to_obj(vals[0])).format('YYYY-MM-DD');
			var to_date = moment(frappe.datetime.user_to_obj(vals[vals.length - 1])).format('YYYY-MM-DD');
			return [from_date, to_date];
		}
	},
	format_for_input: function format_for_input(value1, value2) {
		if (value1 && value2) {
			value1 = frappe.datetime.str_to_user(value1);
			value2 = frappe.datetime.str_to_user(value2);
			return __("{0} to {1}", [value1, value2]);
		}
		return "";
	}
});

frappe.ui.form.ControlSelect = frappe.ui.form.ControlData.extend({
	html_element: "select",
	make_input: function make_input() {
		this._super();
		this.set_options();
	},
	set_formatted_input: function set_formatted_input(value) {
		if (value == null) value = '';
		this.set_options(value);

		this._super(value);

		var input_value = '';
		if (this.$input) {
			input_value = this.$input.val();
		}

		if (value && input_value && value !== input_value) {
			this.set_model_value(input_value);
		}
	},
	set_options: function set_options(value) {
		var options = this.df.options || [];

		if (typeof this.df.options === "string") {
			options = this.df.options.split("\n");
		}

		if (options.toString() === this.last_options) {
			return;
		}
		this.last_options = options.toString();

		if (this.$input) {
			var selected = this.$input.find(":selected").val();
			this.$input.empty().add_options(options || []);

			if (value === undefined && selected) {
				this.$input.val(selected);
			}
		}
	},
	get_file_attachment_list: function get_file_attachment_list() {
		if (!this.frm) return;
		var fl = frappe.model.docinfo[this.frm.doctype][this.frm.docname];
		if (fl && fl.attachments) {
			this.set_description("");
			var options = [""];
			$.each(fl.attachments, function (i, f) {
				options.push(f.file_url);
			});
			return options;
		} else {
			this.set_description(__("Please attach a file first."));
			return [""];
		}
	}
});

frappe.ui.form.ControlLink = frappe.ui.form.ControlData.extend({
	make_input: function make_input() {
		var me = this;

		$('<div class="link-field ui-front" style="position: relative; line-height: 1;">\
			<input type="text" class="input-with-feedback form-control">\
			<span class="link-btn">\
				<a class="btn-open no-decoration" title="' + __("Open Link") + '">\
					<i class="octicon octicon-arrow-right"></i></a>\
			</span>\
		</div>').prependTo(this.input_area);
		this.$input_area = $(this.input_area);
		this.$input = this.$input_area.find('input');
		this.$link = this.$input_area.find('.link-btn');
		this.$link_open = this.$link.find('.btn-open');
		this.set_input_attributes();
		this.$input.on("focus", function () {
			setTimeout(function () {
				if (me.$input.val() && me.get_options()) {
					me.$link.toggle(true);
					me.$link_open.attr('href', '#Form/' + me.get_options() + '/' + me.$input.val());
				}

				if (!me.$input.val()) {
					me.$input.val("").trigger("input");
				}
			}, 500);
		});
		this.$input.on("blur", function () {
			setTimeout(function () {
				me.$link.toggle(false);
			}, 500);
		});
		this.input = this.$input.get(0);
		this.has_input = true;
		this.translate_values = true;
		this.setup_buttons();
		this.setup_awesomeplete();
	},
	get_options: function get_options() {
		return this.df.options;
	},
	setup_buttons: function setup_buttons() {
		if (this.only_input && !this.with_link_btn) {
			this.$input_area.find(".link-btn").remove();
		}
	},
	open_advanced_search: function open_advanced_search() {
		var doctype = this.get_options();
		if (!doctype) return;
		new frappe.ui.form.LinkSelector({
			doctype: doctype,
			target: this,
			txt: this.get_input_value()
		});
		return false;
	},
	new_doc: function new_doc() {
		var doctype = this.get_options();
		var me = this;

		if (!doctype) return;

		if (this.df.get_route_options_for_new_doc) {
			frappe.route_options = this.df.get_route_options_for_new_doc(this);
		} else {
			frappe.route_options = {};
		}

		frappe.route_options.name_field = this.get_value();

		frappe._from_link = this;
		frappe._from_link_scrollY = $(document).scrollTop();

		frappe.ui.form.make_quick_entry(doctype, function (doc) {
			return me.set_value(doc.name);
		});

		return false;
	},
	setup_awesomeplete: function setup_awesomeplete() {
		var me = this;

		this.$input.cache = {};

		this.awesomplete = new Awesomplete(me.input, {
			minChars: 0,
			maxItems: 99,
			autoFirst: true,
			list: [],
			data: function data(item) {
				return {
					label: item.label || item.value,
					value: item.value
				};
			},
			filter: function filter() {
				return true;
			},
			item: function item(_item) {
				var d = this.get_item(_item.value);
				if (!d.label) {
					d.label = d.value;
				}

				var _label = me.translate_values ? __(d.label) : d.label;
				var html = "<strong>" + _label + "</strong>";
				if (d.description && d.value !== d.description) {
					html += '<br><span class="small">' + __(d.description) + '</span>';
				}
				return $('<li></li>').data('item.autocomplete', d).prop('aria-selected', 'false').html('<a><p>' + html + '</p></a>').get(0);
			},
			sort: function sort() {
				return 0;
			}
		});

		this.$input.on("input", frappe.utils.debounce(function (e) {
			var doctype = me.get_options();
			if (!doctype) return;
			if (!me.$input.cache[doctype]) {
				me.$input.cache[doctype] = {};
			}

			var term = e.target.value;

			if (me.$input.cache[doctype][term] != null) {
				me.awesomplete.list = me.$input.cache[doctype][term];
			}

			var args = {
				'txt': term,
				'doctype': doctype
			};

			me.set_custom_query(args);

			frappe.call({
				type: "GET",
				method: 'frappe.desk.search.search_link',
				no_spinner: true,
				args: args,
				callback: function callback(r) {
					if (!me.$input.is(":focus")) {
						return;
					}

					if (!me.df.only_select) {
						if (frappe.model.can_create(doctype) && me.df.fieldtype !== "Dynamic Link") {
							r.results.push({
								label: "<span class='text-primary link-option'>" + "<i class='fa fa-plus' style='margin-right: 5px;'></i> " + __("Create a new {0}", [__(me.df.options)]) + "</span>",
								value: "create_new__link_option",
								action: me.new_doc
							});
						}

						r.results.push({
							label: "<span class='text-primary link-option'>" + "<i class='fa fa-search' style='margin-right: 5px;'></i> " + __("Advanced Search") + "</span>",
							value: "advanced_search__link_option",
							action: me.open_advanced_search
						});
					}
					me.$input.cache[doctype][term] = r.results;
					me.awesomplete.list = me.$input.cache[doctype][term];
				}
			});
		}, 618));

		this.$input.on("blur", function () {
			if (me.selected) {
				me.selected = false;
				return;
			}
			var value = me.get_input_value();
			if (value !== me.last_value) {
				me.parse_validate_and_set_in_model(value);
			}
		});

		this.$input.on("awesomplete-open", function () {
			me.$wrapper.css({ "z-index": 100 });
			me.$wrapper.find('ul').css({ "z-index": 100 });
			me.autocomplete_open = true;
		});

		this.$input.on("awesomplete-close", function () {
			me.$wrapper.css({ "z-index": 1 });
			me.autocomplete_open = false;
		});

		this.$input.on("awesomplete-select", function (e) {
			var o = e.originalEvent;
			var item = me.awesomplete.get_item(o.text.value);

			me.autocomplete_open = false;

			var TABKEY = 9;
			if (e.keyCode === TABKEY) {
				e.preventDefault();
				me.awesomplete.close();
				return false;
			}

			if (item.action) {
				item.value = "";
				item.action.apply(me);
			}

			if (me.df.remember_last_selected_value) {
				frappe.boot.user.last_selected_values[me.df.options] = item.value;
			}

			me.parse_validate_and_set_in_model(item.value);
		});

		this.$input.on("awesomplete-selectcomplete", function (e) {
			var o = e.originalEvent;
			if (o.text.value.indexOf("__link_option") !== -1) {
				me.$input.val("");
			}
		});
	},
	set_custom_query: function set_custom_query(args) {
		var set_nulls = function set_nulls(obj) {
			$.each(obj, function (key, value) {
				if (value !== undefined) {
					obj[key] = value;
				}
			});
			return obj;
		};
		if (this.get_query || this.df.get_query) {
			var get_query = this.get_query || this.df.get_query;
			if ($.isPlainObject(get_query)) {
				var filters = null;
				if (get_query.filters) {
					filters = get_query.filters;
				} else if (get_query.query) {
					args.query = get_query;
				} else {
					filters = get_query;
				}

				if (filters) {
					filters = set_nulls(filters);

					$.extend(args, filters);

					args.filters = filters;
				}
			} else if (typeof get_query === "string") {
				args.query = get_query;
			} else {
				var q = get_query(this.frm && this.frm.doc || this.doc, this.doctype, this.docname);

				if (typeof q === "string") {
					args.query = q;
				} else if ($.isPlainObject(q)) {
					if (q.filters) {
						set_nulls(q.filters);
					}

					if (q.translate_values !== undefined) {
						this.translate_values = q.translate_values;
					}

					$.extend(args, q);

					args.filters = q.filters;
				}
			}
		}
		if (this.df.filters) {
			set_nulls(this.df.filters);
			if (!args.filters) args.filters = {};
			$.extend(args.filters, this.df.filters);
		}
	},
	validate: function validate(value) {
		if (this.df.options == "[Select]" || this.df.ignore_link_validation) {
			return value;
		}

		return this.validate_link_and_fetch(this.df, this.get_options(), this.docname, value);
	},
	validate_link_and_fetch: function validate_link_and_fetch(df, doctype, docname, value) {
		var _this = this;

		var me = this;

		if (value) {
			return new Promise(function (resolve) {
				var fetch = '';

				if (_this.frm && _this.frm.fetch_dict[df.fieldname]) {
					fetch = _this.frm.fetch_dict[df.fieldname].columns.join(', ');
				}

				return frappe.call({
					method: 'frappe.desk.form.utils.validate_link',
					type: "GET",
					args: {
						'value': value,
						'options': doctype,
						'fetch': fetch
					},
					no_spinner: true,
					callback: function callback(r) {
						if (r.message == 'Ok') {
							if (r.fetch_values && docname) {
								me.set_fetch_values(df, docname, r.fetch_values);
							}
							resolve(r.valid_value);
						} else {
							resolve("");
						}
					}
				});
			});
		}
	},
	set_fetch_values: function set_fetch_values(df, docname, fetch_values) {
		var fl = this.frm.fetch_dict[df.fieldname].fields;
		for (var i = 0; i < fl.length; i++) {
			frappe.model.set_value(df.parent, docname, fl[i], fetch_values[i], df.fieldtype);
		}
	}
});

if (Awesomplete) {
	Awesomplete.prototype.get_item = function (value) {
		return this._list.find(function (item) {
			return item.value === value;
		});
	};
}

frappe.ui.form.ControlDynamicLink = frappe.ui.form.ControlLink.extend({
	get_options: function get_options() {
		var options = '';
		if (this.df.get_options) {
			options = this.df.get_options();
		} else if (this.docname == null && cur_dialog) {
			options = cur_dialog.get_value(this.df.options);
		} else if (!cur_frm) {
			var selector = 'input[data-fieldname="' + this.df.options + '"]';
			var input = null;
			if (cur_list) {
				input = cur_list.wrapper.find(selector);
			}
			if (cur_page) {
				input = $(cur_page.page).find(selector);
			}
			if (input) {
				options = input.val();
			}
		} else {
			options = frappe.model.get_value(this.df.parent, this.docname, this.df.options);
		}

		if (frappe.model.is_single(options)) {
			frappe.throw(__(options.bold() + ' is not a valid DocType for Dynamic Link'));
		}

		return options;
	}
});

frappe.ui.form.ControlText = frappe.ui.form.ControlData.extend({
	html_element: "textarea",
	horizontal: false,
	make_wrapper: function make_wrapper() {
		this._super();
		this.$wrapper.find(".like-disabled-input").addClass("for-description");
	},
	make_input: function make_input() {
		this._super();
		this.$input.css({ 'height': '300px' });
	}
});

frappe.ui.form.ControlLongText = frappe.ui.form.ControlText;
frappe.ui.form.ControlSmallText = frappe.ui.form.ControlText.extend({
	make_input: function make_input() {
		this._super();
		this.$input.css({ 'height': '150px' });
	}
});

frappe.ui.form.ControlCode = frappe.ui.form.ControlText.extend({
	make_input: function make_input() {
		this._super();
		$(this.input_area).find("textarea").allowTabs().addClass('control-code');
	}
});

frappe.ui.form.ControlTextEditor = frappe.ui.form.ControlCode.extend({
	make_input: function make_input() {
		var _this = this;

		this.has_input = true;
		this.make_editor();
		this.hide_elements_on_mobile();
		this.setup_drag_drop();
		this.setup_image_dialog();
		this.setting_count = 0;

		$(document).on('form-refresh', function () {
			_this.last_keystroke_on = null;
		});
	},
	render_camera_button: function render_camera_button(context) {
		var ui = $.summernote.ui;
		var button = ui.button({
			contents: '<i class="fa fa-camera"/>',
			tooltip: 'Camera',
			click: function click() {
				var capture = new frappe.ui.Capture();
				capture.open();

				capture.click(function (data) {
					context.invoke('editor.insertImage', data);
				});
			}
		});

		return button.render();
	},
	make_editor: function make_editor() {
		var me = this;
		this.editor = $("<div>").appendTo(this.input_area);

		this.editor.summernote({
			minHeight: 400,
			toolbar: [['magic', ['style']], ['style', ['bold', 'italic', 'underline', 'clear']], ['fontsize', ['fontsize']], ['color', ['color']], ['para', ['ul', 'ol', 'paragraph', 'hr']], ['media', ['link', 'picture', 'camera', 'video', 'table']], ['misc', ['fullscreen', 'codeview']]],
			buttons: {
				camera: this.render_camera_button
			},
			keyMap: {
				pc: {
					'CTRL+ENTER': ''
				},
				mac: {
					'CMD+ENTER': ''
				}
			},
			prettifyHtml: true,
			dialogsInBody: true,
			callbacks: {
				onInit: function onInit() {
					$(".note-editable[contenteditable='true']").one('focus', function () {
						var $this = $(this);
						if (!$this.html()) $this.html($this.html() + '<br>');
					});
				},
				onChange: function onChange(value) {
					me.parse_validate_and_set_in_model(value);
				},
				onKeydown: function onKeydown(e) {
					me.last_keystroke_on = new Date();
					var key = frappe.ui.keys.get_key(e);

					if (['ctrl+b', 'meta+b'].indexOf(key) !== -1) {
						e.stopPropagation();
					}
					if (key.indexOf('escape') !== -1) {
						if (me.note_editor.hasClass('fullscreen')) {
							me.note_editor.find('.note-btn.btn-fullscreen').trigger('click');
						}
					}
				}
			},
			icons: {
				'align': 'fa fa-align',
				'alignCenter': 'fa fa-align-center',
				'alignJustify': 'fa fa-align-justify',
				'alignLeft': 'fa fa-align-left',
				'alignRight': 'fa fa-align-right',
				'indent': 'fa fa-indent',
				'outdent': 'fa fa-outdent',
				'arrowsAlt': 'fa fa-arrows-alt',
				'bold': 'fa fa-bold',
				'camera': 'fa fa-camera',
				'caret': 'caret',
				'circle': 'fa fa-circle',
				'close': 'fa fa-close',
				'code': 'fa fa-code',
				'eraser': 'fa fa-eraser',
				'font': 'fa fa-font',
				'frame': 'fa fa-frame',
				'italic': 'fa fa-italic',
				'link': 'fa fa-link',
				'unlink': 'fa fa-chain-broken',
				'magic': 'fa fa-magic',
				'menuCheck': 'fa fa-check',
				'minus': 'fa fa-minus',
				'orderedlist': 'fa fa-list-ol',
				'pencil': 'fa fa-pencil',
				'picture': 'fa fa-image',
				'question': 'fa fa-question',
				'redo': 'fa fa-redo',
				'square': 'fa fa-square',
				'strikethrough': 'fa fa-strikethrough',
				'subscript': 'fa fa-subscript',
				'superscript': 'fa fa-superscript',
				'table': 'fa fa-table',
				'textHeight': 'fa fa-text-height',
				'trash': 'fa fa-trash',
				'underline': 'fa fa-underline',
				'undo': 'fa fa-undo',
				'unorderedlist': 'fa fa-list-ul',
				'video': 'fa fa-video-camera'
			}
		});
		this.note_editor = $(this.input_area).find('.note-editor');
	},
	setup_drag_drop: function setup_drag_drop() {
		var me = this;
		this.note_editor.on('dragenter dragover', false).on('drop', function (e) {
			var dataTransfer = e.originalEvent.dataTransfer;

			if (dataTransfer && dataTransfer.files && dataTransfer.files.length) {
				me.note_editor.focus();

				var files = [].slice.call(dataTransfer.files);

				files.forEach(function (file) {
					me.get_image(file, function (url) {
						me.editor.summernote('insertImage', url, file.name);
					});
				});
			}
			e.preventDefault();
			e.stopPropagation();
		});
	},
	get_image: function get_image(fileobj, callback) {
		var reader = new FileReader();

		reader.onload = function () {
			var dataurl = reader.result;

			var parts = dataurl.split(",");
			parts[0] += ";filename=" + fileobj.name;
			dataurl = parts[0] + ',' + parts[1];
			callback(dataurl);
		};
		reader.readAsDataURL(fileobj);
	},
	hide_elements_on_mobile: function hide_elements_on_mobile() {
		this.note_editor.find('.note-btn-underline,\
			.note-btn-italic, .note-fontsize,\
			.note-color, .note-height, .btn-codeview').addClass('hidden-xs');
		if ($('.toggle-sidebar').is(':visible')) {
			this.note_editor.find('.note-btn').attr('data-original-title', '');
		}
	},
	get_input_value: function get_input_value() {
		return this.editor ? this.editor.summernote('code') : '';
	},
	parse: function parse(value) {
		if (value == null) value = "";
		return frappe.dom.remove_script_and_style(value);
	},
	set_formatted_input: function set_formatted_input(value) {
		if (value !== this.get_input_value()) {
			this.set_in_editor(value);
		}
	},
	set_in_editor: function set_in_editor(value) {
		var _this2 = this;

		if (this.setting_count > 2) {
			return;
		}

		this.setting_count += 1;

		var time_since_last_keystroke = moment() - moment(this.last_keystroke_on);

		if (!this.last_keystroke_on || time_since_last_keystroke > 3000) {
			setTimeout(function () {
				return _this2.setting_count = 0;
			}, 500);
			this.editor.summernote('code', value || '');
			this.last_keystroke_on = null;
		} else {
			this._setting_value = setInterval(function () {
				if (time_since_last_keystroke > 3000) {
					if (_this2.last_value !== _this2.get_input_value()) {
						_this2.editor.summernote('code', _this2.last_value || '');
					}
					clearInterval(_this2._setting_value);
					_this2._setting_value = null;
					_this2.setting_count = 0;

					_this2.last_keystroke_on = null;
				}
			}, 1000);
		}
	},
	set_focus: function set_focus() {
		return this.editor.summernote('focus');
	},
	set_upload_options: function set_upload_options() {
		var me = this;
		this.upload_options = {
			parent: this.image_dialog.get_field("upload_area").$wrapper,
			args: {},
			max_width: this.df.max_width,
			max_height: this.df.max_height,
			options: "Image",
			no_socketio: true,
			btn: this.image_dialog.set_primary_action(__("Insert")),
			on_no_attach: function on_no_attach() {
				var selected = me.image_dialog.get_field("select").get_value();
				if (selected) {
					me.editor.summernote('insertImage', selected);
					me.image_dialog.hide();
				} else {
					frappe.msgprint(__("Please attach a file or set a URL"));
				}
			},
			callback: function callback(attachment) {
				me.editor.summernote('insertImage', attachment.file_url, attachment.file_name);
				me.image_dialog.hide();
			},
			onerror: function onerror() {
				me.image_dialog.hide();
			}
		};

		if ("is_private" in this.df) {
			this.upload_options.is_private = this.df.is_private;
		}

		if (this.frm) {
			this.upload_options.args = {
				from_form: 1,
				doctype: this.frm.doctype,
				docname: this.frm.docname
			};
		} else {
			this.upload_options.on_attach = function (fileobj, dataurl) {
				me.editor.summernote('insertImage', dataurl);
				me.image_dialog.hide();
				frappe.hide_progress();
			};
		}
	},

	setup_image_dialog: function setup_image_dialog() {
		var _this3 = this;

		this.note_editor.find('[data-original-title="Image"]').on('click', function () {
			if (!_this3.image_dialog) {
				_this3.image_dialog = new frappe.ui.Dialog({
					title: __("Image"),
					fields: [{ fieldtype: "HTML", fieldname: "upload_area" }, { fieldtype: "HTML", fieldname: "or_attach", options: __("Or") }, { fieldtype: "Select", fieldname: "select", label: __("Select from existing attachments") }]
				});
			}

			_this3.image_dialog.show();
			_this3.image_dialog.get_field("upload_area").$wrapper.empty();

			var attachments = _this3.frm && _this3.frm.attachments.get_attachments() || [];
			var select = _this3.image_dialog.get_field("select");
			if (attachments.length) {
				attachments = $.map(attachments, function (o) {
					return o.file_url;
				});
				select.df.options = [""].concat(attachments);
				select.toggle(true);
				_this3.image_dialog.get_field("or_attach").toggle(true);
				select.refresh();
			} else {
				_this3.image_dialog.get_field("or_attach").toggle(false);
				select.toggle(false);
			}
			select.$input.val("");

			_this3.set_upload_options();
			frappe.upload.make(_this3.upload_options);
		});
	}
});

frappe.ui.form.ControlCheck = frappe.ui.form.ControlData.extend({
	input_type: "checkbox",
	make_wrapper: function make_wrapper() {
		this.$wrapper = $('<div class="form-group frappe-control">\
			<div class="checkbox">\
				<label>\
					<span class="input-area"></span>\
					<span class="disp-area"></span>\
					<span class="label-area small"></span>\
				</label>\
				<p class="help-box small text-muted"></p>\
			</div>\
		</div>').appendTo(this.parent);
	},
	set_input_areas: function set_input_areas() {
		this.label_area = this.label_span = this.$wrapper.find(".label-area").get(0);
		this.input_area = this.$wrapper.find(".input-area").get(0);
		this.disp_area = this.$wrapper.find(".disp-area").get(0);
	},
	make_input: function make_input() {
		this._super();
		this.$input.removeClass("form-control");
	},
	get_input_value: function get_input_value() {
		return this.input && this.input.checked ? 1 : 0;
	},
	validate: function validate(value) {
		return cint(value);
	},
	set_input: function set_input(value) {
		if (this.input) {
			this.input.checked = value ? 1 : 0;
		}
		this.last_value = value;
		this.set_mandatory(value);
		this.set_disp_area(value);
	}
});

frappe.ui.form.ControlImage = frappe.ui.form.Control.extend({
	make: function make() {
		this._super();
		this.$wrapper.css({ "margin": "0px" });
		this.$body = $("<div></div>").appendTo(this.$wrapper).css({ "margin-bottom": "10px" });
		$('<div class="clearfix"></div>').appendTo(this.$wrapper);
	},
	refresh_input: function refresh_input() {
		this.$body.empty();

		var doc = this.get_doc();
		if (doc && this.df.options && doc[this.df.options]) {
			this.$img = $("<img src='" + doc[this.df.options] + "' class='img-responsive'>").appendTo(this.$body);
		} else {
			this.$buffer = $("<div class='missing-image'><i class='octicon octicon-circle-slash'></i></div>").appendTo(this.$body);
		}
		return false;
	}
});

frappe.ui.form.ControlAttach = frappe.ui.form.ControlData.extend({
	make_input: function make_input() {
		var me = this;
		this.$input = $('<button class="btn btn-default btn-sm btn-attach">').html(__("Attach")).prependTo(me.input_area).on("click", function () {
			me.onclick();
		});
		this.$value = $("<div class=\"attached-file\">\n\t\t\t\t<div class=\"ellipsis\">\n\t\t\t\t\t<i class=\"fa fa-paperclip\"></i>\n\t\t\t\t\t<a class=\"attached-file-link\" target=\"_blank\"></a>\n\t\t\t\t</div>\n\t\t\t\t<a class=\"close\">&times;</a>\n\t\t\t</div>").prependTo(me.input_area).toggle(false);
		this.input = this.$input.get(0);
		this.set_input_attributes();
		this.has_input = true;

		this.$value.find(".close").on("click", function () {
			me.clear_attachment();
		});
	},
	clear_attachment: function clear_attachment() {
		var me = this;
		if (this.frm) {
			me.frm.attachments.remove_attachment_by_filename(me.value, function () {
				me.parse_validate_and_set_in_model(null);
				me.refresh();
				me.frm.save();
			});
		} else {
			this.dataurl = null;
			this.fileobj = null;
			this.set_input(null);
			this.refresh();
		}
	},
	onclick: function onclick() {
		var me = this;
		if (this.doc) {
			var doc = this.doc.parent && frappe.model.get_doc(this.doc.parenttype, this.doc.parent) || this.doc;
			if (doc.__islocal) {
				frappe.msgprint(__("Please save the document before uploading."));
				return;
			}
		}
		if (!this.dialog) {
			this.dialog = new frappe.ui.Dialog({
				title: __(this.df.label || __("Upload")),
				fields: [{ fieldtype: "HTML", fieldname: "upload_area" }, { fieldtype: "HTML", fieldname: "or_attach", options: __("Or") }, { fieldtype: "Select", fieldname: "select", label: __("Select from existing attachments") }, { fieldtype: "Button", fieldname: "clear",
					label: __("Clear Attachment"), click: function click() {
						me.clear_attachment();
						me.dialog.hide();
					}
				}]
			});
		}

		this.dialog.show();

		this.dialog.get_field("upload_area").$wrapper.empty();

		var attachments = this.frm && this.frm.attachments.get_attachments() || [];
		var select = this.dialog.get_field("select");
		if (attachments.length) {
			attachments = $.map(attachments, function (o) {
				return o.file_url;
			});
			select.df.options = [""].concat(attachments);
			select.toggle(true);
			this.dialog.get_field("or_attach").toggle(true);
			select.refresh();
		} else {
			this.dialog.get_field("or_attach").toggle(false);
			select.toggle(false);
		}
		select.$input.val("");

		this.dialog.get_field('clear').$wrapper.toggle(this.get_model_value() ? true : false);

		this.set_upload_options();
		frappe.upload.make(this.upload_options);
	},

	set_upload_options: function set_upload_options() {
		var me = this;
		this.upload_options = {
			parent: this.dialog.get_field("upload_area").$wrapper,
			args: {},
			allow_multiple: 0,
			max_width: this.df.max_width,
			max_height: this.df.max_height,
			options: this.df.options,
			btn: this.dialog.set_primary_action(__("Upload")),
			on_no_attach: function on_no_attach() {
				var selected = me.dialog.get_field("select").get_value();
				if (selected) {
					me.parse_validate_and_set_in_model(selected);
					me.dialog.hide();
					me.frm.save();
				} else {
					frappe.msgprint(__("Please attach a file or set a URL"));
				}
			},
			callback: function callback(attachment) {
				me.on_upload_complete(attachment);
				me.dialog.hide();
			},
			onerror: function onerror() {
				me.dialog.hide();
			}
		};

		if ("is_private" in this.df) {
			this.upload_options.is_private = this.df.is_private;
		}

		if (this.frm) {
			this.upload_options.args = {
				from_form: 1,
				doctype: this.frm.doctype,
				docname: this.frm.docname
			};
		} else {
			this.upload_options.on_attach = function (fileobj, dataurl) {
				me.dialog.hide();
				me.fileobj = fileobj;
				me.dataurl = dataurl;
				if (me.on_attach) {
					me.on_attach();
				}
				if (me.df.on_attach) {
					me.df.on_attach(fileobj, dataurl);
				}
				me.on_upload_complete();
			};
		}
	},

	set_input: function set_input(value, dataurl) {
		this.value = value;
		if (this.value) {
			this.$input.toggle(false);
			if (this.value.indexOf(",") !== -1) {
				var parts = this.value.split(",");
				var filename = parts[0];
				dataurl = parts[1];
			}
			this.$value.toggle(true).find(".attached-file-link").html(filename || this.value).attr("href", dataurl || this.value);
		} else {
			this.$input.toggle(true);
			this.$value.toggle(false);
		}
	},

	get_value: function get_value() {
		if (this.frm) {
			return this.value;
		} else {
			if (this.fileobj) {
				if (this.fileobj.file_url) {
					return this.fileobj.file_url;
				} else if (this.fileobj.filename) {
					var dataURI = this.fileobj.filename + ',' + this.dataurl;

					return dataURI;
				}
			}

			return null;
		}
	},

	on_upload_complete: function on_upload_complete(attachment) {
		if (this.frm) {
			this.parse_validate_and_set_in_model(attachment.file_url);
			this.refresh();
			this.frm.attachments.update_attachment(attachment);
			this.frm.save();
		} else {
			this.value = this.get_value();
			this.refresh();
			frappe.hide_progress();
		}
	}
});

frappe.ui.form.ControlAttachImage = frappe.ui.form.ControlAttach.extend({
	make: function make() {
		var me = this;
		this._super();

		this.container = $('<div class="control-container">').insertAfter($(this.wrapper));
		$(this.wrapper).detach();
		this.container.attr('data-fieldtype', this.df.fieldtype).append(this.wrapper);
		if (this.df.align === 'center') {
			this.container.addClass("flex-justify-center");
		} else if (this.df.align === 'right') {
			this.container.addClass("flex-justify-end");
		}

		this.img_wrapper = $('<div style="width: 100%; height: calc(100% - 40px); position: relative;">\
			<div class="missing-image attach-missing-image"><i class="octicon octicon-device-camera"></i></div></div>').appendTo(this.wrapper);

		this.img_container = $('<div class=\'img-container\'></div>');
		this.img = $('<img class=\'img-responsive attach-image-display\'>').appendTo(this.img_container);

		this.img_overlay = $('<div class=\'img-overlay\'>\n\t\t\t\t<span class="overlay-text">Change</span>\n\t\t\t</div>').appendTo(this.img_container);

		this.remove_image_link = $('<a style="font-size: 12px;color: #8D99A6;">Remove</a>');

		this.img_wrapper.append(this.img_container).append(this.remove_image_link);

		this.img_container.toggle(false);
		this.remove_image_link.toggle(false);

		this.img_wrapper.find(".missing-image").on("click", function () {
			me.$input.click();
		});
		this.img_container.on("click", function () {
			me.$input.click();
		});
		this.remove_image_link.on("click", function () {
			me.$value.find(".close").click();
		});

		this.set_image();
	},
	refresh_input: function refresh_input() {
		this._super();
		$(this.wrapper).find('.btn-attach').addClass('hidden');
		this.set_image();
		if (this.get_status() == "Read") {
			$(this.disp_area).toggle(false);
		}
	},
	set_image: function set_image() {
		if (this.get_value()) {
			$(this.img_wrapper).find(".missing-image").toggle(false);

			this.img.attr("src", this.dataurl ? this.dataurl : this.value);
			this.img_container.toggle(true);
			this.remove_image_link.toggle(true);
		} else {
			$(this.img_wrapper).find(".missing-image").toggle(true);

			this.img_container.toggle(false);
			this.remove_image_link.toggle(false);
		}
	}
});

frappe.ui.form.ControlTable = frappe.ui.form.Control.extend({
	make: function make() {
		this._super();

		this.grid = new frappe.ui.form.Grid({
			frm: this.frm,
			df: this.df,
			perm: this.perm || this.frm && this.frm.perm || this.df.perm,
			parent: this.wrapper
		});
		if (this.frm) {
			this.frm.grids[this.frm.grids.length] = this;
		}

		if (this.df.description) {
			$('<p class="text-muted small">' + __(this.df.description) + '</p>').appendTo(this.wrapper);
		}
	},
	refresh_input: function refresh_input() {
		this.grid.refresh();
	},
	get_value: function get_value() {
		if (this.grid) {
			return this.grid.get_data();
		}
	}
});

frappe.ui.form.ControlColor = frappe.ui.form.ControlData.extend({
	make_input: function make_input() {
		this._super();
		this.colors = ["#ffc4c4", "#ff8989", "#ff4d4d", "#a83333", "#ffe8cd", "#ffd19c", "#ffb868", "#a87945", "#ffd2c2", "#ffa685", "#ff7846", "#a85b5b", "#ffd7d7", "#ffb1b1", "#ff8989", "#a84f2e", "#fffacd", "#fff168", "#fff69c", "#a89f45", "#ebf8cc", "#d9f399", "#c5ec63", "#7b933d", "#cef6d1", "#9deca2", "#6be273", "#428b46", "#d2f8ed", "#a4f3dd", "#77ecca", "#49937e", "#d2f1ff", "#a6e4ff", "#78d6ff", "#4f8ea8", "#d2d2ff", "#a3a3ff", "#7575ff", "#4d4da8", "#dac7ff", "#b592ff", "#8e58ff", "#5e3aa8", "#f8d4f8", "#f3aaf0", "#ec7dea", "#934f92"];
		this.make_color_input();
	},
	make_color_input: function make_color_input() {
		this.$wrapper.find('.control-input-wrapper').append("<div class=\"color-picker\">\n\t\t\t\t<div class=\"color-picker-pallete\"></div>\n\t\t\t</div>");
		this.$color_pallete = this.$wrapper.find('.color-picker-pallete');

		var color_html = this.colors.map(this.get_color_box).join("");
		this.$color_pallete.append(color_html);
		this.$color_pallete.hide();
		this.bind_events();
	},
	get_color_box: function get_color_box(hex) {
		return "<div class=\"color-box\" data-color=\"" + hex + "\" style=\"background-color: " + hex + "\"></div>";
	},
	set_formatted_input: function set_formatted_input(value) {
		this._super(value);

		if (!value) value = '#FFFFFF';
		var contrast = frappe.ui.color.get_contrast_color(value);

		this.$input.css({
			"background-color": value, "color": contrast
		});
	},
	bind_events: function bind_events() {
		var _this = this;

		var mousedown_happened = false;
		this.$wrapper.on("click", ".color-box", function (e) {
			mousedown_happened = false;

			var color_val = $(e.target).data("color");
			_this.set_value(color_val);

			_this.set_focus();
		});

		this.$wrapper.find(".color-box").mousedown(function () {
			mousedown_happened = true;
		});

		this.$input.on("focus", function () {
			_this.$color_pallete.show();
		});
		this.$input.on("blur", function () {
			if (mousedown_happened) {
				mousedown_happened = false;
			} else {
				$(_this.$color_pallete).hide();
			}
		});
	},
	validate: function validate(value) {
		if (value === '') {
			return '';
		}
		var is_valid = /^#[0-9A-F]{6}$/i.test(value);
		if (is_valid) {
			return value;
		}
		frappe.msgprint(__("{0} is not a valid hex color", [value]));
		return null;
	}
});

frappe.ui.form.ControlSignature = frappe.ui.form.ControlData.extend({
	saving: false,
	loading: false,
	make: function make() {
		var me = this;
		this._super();

		this.body = $('<div class="signature-field"></div>').appendTo(me.wrapper);
		this.make_pad();

		this.img_wrapper = $('<div class="signature-display">\n\t\t\t<div class="missing-image attach-missing-image">\n\t\t\t\t<i class="octicon octicon-circle-slash"></i>\n\t\t\t</div></div>').appendTo(this.wrapper);
		this.img = $("<img class='img-responsive attach-image-display'>").appendTo(this.img_wrapper).toggle(false);
	},
	make_pad: function make_pad() {
		var _this = this;

		var width = this.body.width();
		if (width > 0 && !this.$pad) {
			this.$pad = this.body.jSignature({
				height: 300,
				width: this.body.width(),
				lineWidth: 3
			}).on('change', this.on_save_sign.bind(this));
			this.load_pad();
			this.$reset_button_wrapper = $('<div class="signature-btn-row">\n\t\t\t\t<a href="#" type="button" class="signature-reset btn btn-default">\n\t\t\t\t<i class="glyphicon glyphicon-repeat"></i></a>').appendTo(this.$pad).on("click", '.signature-reset', function () {
				_this.on_reset_sign();
				return false;
			});
		}
	},
	refresh_input: function refresh_input(e) {
		this.make_pad();
		this.$wrapper.find(".control-input").toggle(false);
		this.set_editable(this.get_status() == "Write");
		this.load_pad();
		if (this.get_status() == "Read") {
			$(this.disp_area).toggle(false);
		}
	},
	set_image: function set_image(value) {
		if (value) {
			$(this.img_wrapper).find(".missing-image").toggle(false);
			this.img.attr("src", value).toggle(true);
		} else {
			$(this.img_wrapper).find(".missing-image").toggle(true);
			this.img.toggle(false);
		}
	},
	load_pad: function load_pad() {
		if (this.saving) return;

		var value = this.get_value();

		if (this.$pad) {
			this.loading = true;

			this.$pad.jSignature('reset');
			if (value) {
				try {
					this.$pad.jSignature('setData', value);
					this.set_image(value);
				} catch (e) {
					console.log("Cannot set data for signature", value, e);
				}
			}

			this.loading = false;
		}
	},
	set_editable: function set_editable(editable) {
		this.$pad && this.$pad.toggle(editable);
		this.img_wrapper.toggle(!editable);
		if (this.$reset_button_wrapper) {
			this.$reset_button_wrapper.toggle(editable);
			if (editable) {
				this.$reset_button_wrapper.addClass('editing');
			} else {
				this.$reset_button_wrapper.removeClass('editing');
			}
		}
	},
	set_my_value: function set_my_value(value) {
		if (this.saving || this.loading) return;
		this.saving = true;
		this.set_value(value);
		this.saving = false;
	},
	get_value: function get_value() {
		return this.value ? this.value : this.get_model_value();
	},

	on_reset_sign: function on_reset_sign() {
		this.$pad.jSignature("reset");
		this.set_my_value("");
	},

	on_save_sign: function on_save_sign() {
		if (this.saving || this.loading) return;
		var base64_img = this.$pad.jSignature("getData");
		this.set_my_value(base64_img);
		this.set_image(this.get_value());
	}
});

frappe.ui.form.ControlPassword = frappe.ui.form.ControlData.extend({
	input_type: "password",
	make: function make() {
		this._super();
	},
	make_input: function make_input() {
		var _this = this;

		var me = this;
		this._super();
		this.$input.parent().append($('<span class="password-strength-indicator indicator"></span>'));
		this.$wrapper.find('.control-input-wrapper').append($('<p class="password-strength-message text-muted small hidden"></p>'));

		this.indicator = this.$wrapper.find('.password-strength-indicator');
		this.message = this.$wrapper.find('.help-box');

		this.$input.on('keyup', function () {
			clearTimeout(_this.check_password_timeout);
			_this.check_password_timeout = setTimeout(function () {
				me.get_password_strength(me.$input.val());
			}, 500);
		});
	},
	get_password_strength: function get_password_strength(value) {
		var me = this;
		frappe.call({
			type: 'POST',
			method: 'frappe.core.doctype.user.user.test_password_strength',
			args: {
				new_password: value || ''
			},
			callback: function callback(r) {
				if (r.message && r.message.entropy) {
					var score = r.message.score,
					    feedback = r.message.feedback;

					feedback.crack_time_display = r.message.crack_time_display;

					var indicators = ['grey', 'red', 'orange', 'yellow', 'green'];
					me.set_strength_indicator(indicators[score]);
				}
			}

		});
	},
	set_strength_indicator: function set_strength_indicator(color) {
		var message = __("Include symbols, numbers and capital letters in the password");
		this.indicator.removeClass().addClass('password-strength-indicator indicator ' + color);
		this.message.html(message).removeClass('hidden');
	}
});

frappe.ui.form.ControlReadOnly = frappe.ui.form.ControlData.extend({
	get_status: function get_status(explain) {
		var status = this._super(explain);
		if (status === "Write") status = "Read";
		return;
	}
});

frappe.ui.form.ControlButton = frappe.ui.form.ControlData.extend({
	make_input: function make_input() {
		var me = this;
		this.$input = $('<button class="btn btn-default btn-xs">').prependTo(me.input_area).on("click", function () {
			me.onclick();
		});
		this.input = this.$input.get(0);
		this.set_input_attributes();
		this.has_input = true;
		this.toggle_label(false);
	},
	onclick: function onclick() {
		if (this.frm && this.frm.doc) {
			if (this.frm.script_manager.has_handlers(this.df.fieldname, this.doctype)) {
				this.frm.script_manager.trigger(this.df.fieldname, this.doctype, this.docname);
			} else {
				this.frm.runscript(this.df.options, this);
			}
		} else if (this.df.click) {
			this.df.click();
		}
	},
	set_input_areas: function set_input_areas() {
		this._super();
		$(this.disp_area).removeClass().addClass("hide");
	},
	set_empty_description: function set_empty_description() {
		this.$wrapper.find(".help-box").empty().toggle(false);
	},
	set_label: function set_label() {
		$(this.label_span).html("&nbsp;");
		this.$input && this.$input.html((this.df.icon ? '<i class="' + this.df.icon + ' fa-fw"></i> ' : "") + __(this.df.label));
	}
});

frappe.ui.form.ControlHTML = frappe.ui.form.Control.extend({
	make: function make() {
		this._super();
		this.disp_area = this.wrapper;
	},
	refresh_input: function refresh_input() {
		var content = this.get_content();
		if (content) this.$wrapper.html(content);
	},
	get_content: function get_content() {
		var content = this.df.options || "";
		try {
			return frappe.render(content, this);
		} catch (e) {
			return content;
		}
	},
	html: function html(_html) {
		this.$wrapper.html(_html || this.get_content());
	},
	set_value: function set_value(html) {
		if (html.appendTo) {
			html.appendTo(this.$wrapper.empty());
		} else {
			this.df.options = html;
			this.html(html);
		}
	}
});

frappe.ui.form.ControlHeading = frappe.ui.form.ControlHTML.extend({
	get_content: function get_content() {
		return "<h4>" + __(this.df.label) + "</h4>";
	}
});

frappe.ui.form.ControlAutocomplete = frappe.ui.form.ControlData.extend({
	make_input: function make_input() {
		this._super();
		this.setup_awesomplete();
		this.set_options();
	},
	set_options: function set_options() {
		if (this.df.options) {
			var options = this.df.options || [];
			if (typeof options === 'string') {
				options = options.split('\n');
			}
			this._data = options;
		}
	},
	get_awesomplete_settings: function get_awesomplete_settings() {
		return {
			minChars: 0,
			maxItems: 99,
			autoFirst: true,
			list: this.get_data()
		};
	},
	setup_awesomplete: function setup_awesomplete() {
		var _this = this;

		var me = this;

		this.awesomplete = new Awesomplete(this.input, this.get_awesomplete_settings());

		$(this.input_area).find('.awesomplete ul').css('min-width', '100%');

		this.$input.on('input', function () {
			_this.awesomplete.list = _this.get_data();
		});

		this.$input.on('focus', function () {
			if (!_this.$input.val()) {
				_this.$input.val('');
				_this.$input.trigger('input');
			}
		});

		this.$input.on('awesomplete-selectcomplete', function () {
			_this.$input.trigger('change');
		});
	},
	get_data: function get_data() {
		return this._data || [];
	},
	set_data: function set_data(data) {
		if (this.awesomplete) {
			this.awesomplete.list = data;
		}
		this._data = data;
	}
});

frappe.ui.form.ControlBarcode = frappe.ui.form.ControlData.extend({
	make_wrapper: function make_wrapper() {
		var _this = this;

		this._super();

		var $input_wrapper = this.$wrapper.find('.control-input-wrapper');
		this.barcode_area = $('<div class="barcode-wrapper border"><svg height=80></svg></div>');
		frappe.require("assets/frappe/js/lib/JsBarcode.all.min.js", function () {
			_this.barcode_area.appendTo($input_wrapper);
		});
	},
	parse: function parse(value) {
		return this.get_barcode_html(value);
	},
	set_formatted_input: function set_formatted_input(value) {
		var svg = value;
		var barcode_value = $(svg).attr('data-barcode-value');

		this.$input.val(barcode_value);
		this.barcode_area.html(svg);
	},
	get_barcode_html: function get_barcode_html(value) {
		var svg = this.barcode_area.find('svg')[0];
		JsBarcode(svg, value, this.get_options(value));
		$(svg).attr('data-barcode-value', value);
		return this.barcode_area.html();
	},
	get_options: function get_options(value) {
		var options = JSON.parse('{ "height" : 40 }');
		if (this.isValidJson(this.df.options)) {
			options = JSON.parse(this.df.options);
			if (options.format && options.format === "EAN") {
				options.format = value.length == 8 ? "EAN8" : "EAN13";
			}

			if (options.valueField) {
				this.frm.set_value(options.valueField, value);
			}
		}
		return options;
	},
	isValidJson: function isValidJson(jsonData) {
		try {
			JSON.parse(jsonData);
			return true;
		} catch (e) {
			return false;
		}
	}
});

frappe.ui.form.ControlGeolocation = frappe.ui.form.ControlCode.extend({
	make_wrapper: function make_wrapper() {
		this._super();

		var $input_wrapper = this.$wrapper.find('.control-input-wrapper');
		this.map_id = frappe.dom.get_unique_id();
		this.map_area = $('<div class="map-wrapper border">\n\t\t\t\t<div id="' + this.map_id + '" style="min-height: 400px; z-index: 1; max-width:100%"></div>\n\t\t\t</div>');
		this.map_area.prependTo($input_wrapper);
		this.$wrapper.find('.control-input').addClass("hidden");
		this.bind_leaflet_map();
		this.bind_leaflet_draw_control();
		this.bind_leaflet_locate_control();
		this.bind_leaflet_refresh_button();
	},
	format_for_input: function format_for_input(value) {
		this.clear_editable_layers();
		if (value) {
			var data_layers = new L.FeatureGroup().addLayer(L.geoJson(JSON.parse(value), {
				pointToLayer: function pointToLayer(geoJsonPoint, latlng) {
					if (geoJsonPoint.properties.point_type == "circle") {
						return L.circle(latlng, { radius: geoJsonPoint.properties.radius });
					} else if (geoJsonPoint.properties.point_type == "circlemarker") {
						return L.circleMarker(latlng, { radius: geoJsonPoint.properties.radius });
					} else {
						return L.marker(latlng);
					}
				}
			}));
			this.add_non_group_layers(data_layers, this.editableLayers);
			try {
				this.map.flyToBounds(this.editableLayers.getBounds(), {
					padding: [50, 50]
				});
			} catch (err) {}
			this.editableLayers.addTo(this.map);
			this.map._onResize();
		} else if (value === undefined || value == JSON.stringify(new L.FeatureGroup().toGeoJSON())) {
			this.locate_control.start();
		}
	},
	bind_leaflet_map: function bind_leaflet_map() {

		var circleToGeoJSON = L.Circle.prototype.toGeoJSON;
		L.Circle.include({
			toGeoJSON: function toGeoJSON() {
				var feature = circleToGeoJSON.call(this);
				feature.properties = {
					point_type: 'circle',
					radius: this.getRadius()
				};
				return feature;
			}
		});

		L.CircleMarker.include({
			toGeoJSON: function toGeoJSON() {
				var feature = circleToGeoJSON.call(this);
				feature.properties = {
					point_type: 'circlemarker',
					radius: this.getRadius()
				};
				return feature;
			}
		});

		L.Icon.Default.imagePath = '/assets/frappe/images/leaflet/';
		this.map = L.map(this.map_id).setView([19.0800, 72.8961], 13);

		L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
			attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(this.map);
	},
	bind_leaflet_locate_control: function bind_leaflet_locate_control() {
		this.locate_control = L.control.locate({ position: 'topright' });
		this.locate_control.addTo(this.map);
	},
	bind_leaflet_draw_control: function bind_leaflet_draw_control() {
		var _this = this;

		this.editableLayers = new L.FeatureGroup();

		var options = {
			position: 'topleft',
			draw: {
				polyline: {
					shapeOptions: {
						color: frappe.ui.color.get('blue'),
						weight: 10
					}
				},
				polygon: {
					allowIntersection: false,
					drawError: {
						color: frappe.ui.color.get('orange'),
						message: '<strong>Oh snap!<strong> you can\'t draw that!' },
					shapeOptions: {
						color: frappe.ui.color.get('blue')
					}
				},
				circle: true,
				rectangle: {
					shapeOptions: {
						clickable: false
					}
				}
			},
			edit: {
				featureGroup: this.editableLayers,
				remove: true
			}
		};

		var drawControl = new L.Control.Draw(options);

		this.map.addControl(drawControl);

		this.map.on('draw:created', function (e) {
			var type = e.layerType,
			    layer = e.layer;
			if (type === 'marker') {
				layer.bindPopup('Marker');
			}
			_this.editableLayers.addLayer(layer);
			_this.set_value(JSON.stringify(_this.editableLayers.toGeoJSON()));
		});

		this.map.on('draw:deleted draw:edited', function (e) {
			var layer = e.layer;
			_this.editableLayers.removeLayer(layer);
			_this.set_value(JSON.stringify(_this.editableLayers.toGeoJSON()));
		});
	},
	bind_leaflet_refresh_button: function bind_leaflet_refresh_button() {
		L.easyButton({
			id: 'refresh-map-' + this.df.fieldname,
			position: 'topright',
			type: 'replace',
			leafletClasses: true,
			states: [{
				stateName: 'refresh-map',
				onClick: function onClick(button, map) {
					map._onResize();
				},
				title: 'Refresh map',
				icon: 'fa fa-refresh'
			}]
		}).addTo(this.map);
	},
	add_non_group_layers: function add_non_group_layers(source_layer, target_group) {
		var _this2 = this;

		if (source_layer instanceof L.LayerGroup) {
			source_layer.eachLayer(function (layer) {
				_this2.add_non_group_layers(layer, target_group);
			});
		} else {
			target_group.addLayer(source_layer);
		}
	},
	clear_editable_layers: function clear_editable_layers() {
		var _this3 = this;

		this.editableLayers.eachLayer(function (l) {
			_this3.editableLayers.removeLayer(l);
		});
	}
});

frappe.ui.form.ControlMultiSelect = frappe.ui.form.ControlAutocomplete.extend({
	get_awesomplete_settings: function get_awesomplete_settings() {
		var settings = this._super();

		return Object.assign(settings, {
			filter: function filter(text, input) {
				return Awesomplete.FILTER_CONTAINS(text, input.match(/[^,]*$/)[0]);
			},

			item: function item(text, input) {
				return Awesomplete.ITEM(text, input.match(/[^,]*$/)[0]);
			},

			replace: function replace(text) {
				var before = this.input.value.match(/^.+,\s*|/)[0];
				this.input.value = before + text + ", ";
			}
		});
	},
	get_data: function get_data() {
		var value = this.get_value() || '';
		var values = value.split(', ').filter(function (d) {
			return d;
		});
		var data = this._super();

		return data.filter(function (d) {
			return !values.includes(d);
		});
	}
});

frappe.ui.form.ControlMultiCheck = frappe.ui.form.Control.extend({
	make: function make() {
		this._super();
		this.$label = $('<label class="control-label">' + (this.df.label || '') + '</label>').appendTo(this.wrapper);
		this.$load_state = $('<div class="load-state text-muted small">' + __("Loading") + '...</div>');
		this.$select_buttons = this.get_select_buttons().appendTo(this.wrapper);
		this.$load_state.appendTo(this.wrapper);

		var row = this.get_column_size() === 12 ? '' : 'row';
		this.$checkbox_area = $('<div class="checkbox-options ' + row + '"></div>').appendTo(this.wrapper);
		this.set_options();
		this.bind_checkboxes();
	},
	refresh_input: function refresh_input() {
		var _this = this;

		this.options.map(function (option) {
			return option.value;
		}).forEach(function (value) {
			$(_this.wrapper).find(':checkbox[data-unit="' + value + '"]').prop("checked", _this.selected_options.includes(value));
		});
	},
	set_options: function set_options() {
		var _this2 = this;

		this.$load_state.show();
		this.$select_buttons.hide();
		this.parse_df_options();

		if (this.df.get_data) {
			if (typeof this.df.get_data().then == 'function') {
				this.df.get_data().then(function (results) {
					_this2.options = results;
					_this2.make_checkboxes();
				});
			} else {
				this.options = this.df.get_data();
				this.make_checkboxes();
			}
		} else {
			this.make_checkboxes();
		}
	},
	parse_df_options: function parse_df_options() {
		if (Array.isArray(this.df.options)) {
			this.options = this.df.options;
		} else if (this.df.options && this.df.options.length > 0 && frappe.utils.is_json(this.df.options)) {
			var args = JSON.parse(this.df.options);
			if (Array.isArray(args)) {
				this.options = args;
			} else if (Array.isArray(args.options)) {
				if (args.select_all) {
					this.select_all = true;
				}
				this.options = args.options;
			}
		} else {
			this.options = [];
		}
	},
	make_checkboxes: function make_checkboxes() {
		var _this3 = this;

		this.set_checked_options();
		this.$load_state.hide();
		this.$checkbox_area.empty();
		this.options.forEach(function (option) {
			_this3.get_checkbox_element(option).appendTo(_this3.$checkbox_area);
		});
		if (this.select_all) {
			this.setup_select_all();
		}
	},
	bind_checkboxes: function bind_checkboxes() {
		var _this4 = this;

		$(this.wrapper).on('change', ':checkbox', function (e) {
			var $checkbox = $(e.target);
			var option_name = $checkbox.attr("data-unit");
			if ($checkbox.is(':checked')) {
				_this4.selected_options.push(option_name);
			} else {
				var index = _this4.selected_options.indexOf(option_name);
				_this4.selected_options.splice(index, 1);
			}
			_this4.df.on_change && _this4.df.on_change();
		});
	},
	set_checked_options: function set_checked_options() {
		this.selected_options = this.options.filter(function (o) {
			return o.checked;
		}).map(function (o) {
			return o.value;
		});
	},
	setup_select_all: function setup_select_all() {
		var _this5 = this;

		this.$select_buttons.show();
		var select_all = function select_all() {
			var deselect = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;

			$(_this5.wrapper).find(':checkbox').prop("checked", deselect).trigger('click');
		};
		this.$select_buttons.find('.select-all').on('click', function () {
			select_all();
		});
		this.$select_buttons.find('.deselect-all').on('click', function () {
			select_all(true);
		});
	},
	get_value: function get_value() {
		return this.selected_options;
	},
	get_checked_options: function get_checked_options() {
		return this.get_value();
	},
	get_unchecked_options: function get_unchecked_options() {
		var _this6 = this;

		return this.options.map(function (o) {
			return o.value;
		}).filter(function (value) {
			return !_this6.selected_options.includes(value);
		});
	},
	get_checkbox_element: function get_checkbox_element(option) {
		var column_size = this.get_column_size();
		return $('\n\t\t\t<div class="checkbox unit-checkbox col-sm-' + column_size + '">\n\t\t\t\t<label>\n\t\t\t\t<input type="checkbox" data-unit="' + option.value + '">\n\t\t\t\t</input>\n\t\t\t\t<span class="label-area small" data-unit="' + option.value + '">' + __(option.label) + '</span>\n\t\t\t\t</label>\n\t\t\t</div>');
	},
	get_select_buttons: function get_select_buttons() {
		return $('<div><button class="btn btn-xs btn-default select-all">\n\t\t\t' + __("Select All") + '</button>\n\t\t\t<button class="btn btn-xs btn-default deselect-all">\n\t\t' + __("Unselect All") + '</button></div>');
	},
	get_column_size: function get_column_size() {
		return 12 / (+this.df.columns || 1);
	}
});